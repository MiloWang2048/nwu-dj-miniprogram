<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.milolab.dj.dao.JobRecordDAO">

    <resultMap id="JobRecordResultMap" type="cn.milolab.dj.bean.entity.JobRecord">
        <id property="id" column="id"/>
        <result property="deleted" column="is_deleted"/>
        <result property="cstCreate" column="cst_create"/>
        <result property="cstModified" column="cst_modified"/>
        <result property="jobId" column="job_id"/>
        <result property="employeeId" column="employee_id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="present" column="is_present"/>
    </resultMap>

    <insert id="insertOne">
        insert into job_record
        (cst_create,
         cst_modified,
         employee_id,
         job_id,
         start_time,
         end_time,
         is_present)
        values (current_timestamp(),
                current_timestamp(),
                #{employeeId},
                #{jobId},
                #{startTime},
                #{startTime},
                #{present})
    </insert>

    <update id="updateWithEntity">
        update job_record
        set employee_id      = #{employeeId},
            job_id       = #{jobId},
            start_time   = #{startTime},
            end_time     = #{endTime},
            is_present   = #{present},
            cst_modified = current_timestamp()
        where id = #{id}
          and is_deleted = false
    </update>

    <update id="deleteById">
        update job_record
        set is_deleted = true
        where id = #{id}
          and is_deleted = false
    </update>

    <select id="getAllJobRecords" resultMap="JobRecordResultMap">
        select *
        from job_record
        where is_deleted = false
    </select>

    <select id="findById" resultMap="JobRecordResultMap">
        select *
        from job_record t1
        where t1.id = #{id}
          and is_deleted = false
    </select>

    <select id="getMyJobsRecord" resultMap="JobRecordResultMap">
        SELECT t2.*
        FROM job AS t1
                 INNER JOIN
             job_record AS t2
             ON
                 t1.id = t2.job_id
        WHERE t1.is_deleted = false
          AND t2.is_deleted = false
          AND t2.employee_id = #{employeeId}
        ORDER BY t1.start_time DESC
    </select>

    <select id="getRecordsForJob" resultMap="JobRecordResultMap">
        SELECT
            t1.*
        FROM
            job_record AS t1
        WHERE
            t1.is_deleted = false AND
            t1.job_id = #{jobId}
    </select>

</mapper>